# refaktor of how ratings are handled and some work on notifications to subscribed users on new episodes

This weekend I rewrot how ratings are handeld after realizing that I was not showing ratings for podcasts in the subscription view, I'm using the same component as in searchresults for podcasts but I was not fetching the ratings, so I fixed that but ended up with two diffrent variabels for ratings in the same component which I didn't like at all. So I rewrote all the routes that fetch episodes and podcasts to add the avrage rating from my own database to the body of each episode/podcast befor returning it to the frontend, this takes care of the initial ratings. For showing updates that are being made while still on the same page I rewrot the rating emition to just emit to one path per episode/podcast and created a RatingReducer that took over the handleing of rating episodes and storing emition from backend, the array thats holding theese emitions is however clered when changing path in the client, this is to avoid the risk of values from "old emitions" beeing shown insted of newly fetched ones.

I'm only listening for emitions for rating updates on a episode if it's in the current view so if I where to keep the emition after I leeve the view, the ratings might have been updated again without the client getting the updates so if the user then goes back to the page the rating might be obsolete becouse I always look at if there are any rating emitions for that specific episode first and at the rating value atached to the body of the episode/podcast in cases that there is no rating in the array of rating emitions. And since going back to the podcasts will trigger a new fetch I will get the latest updates without the rating emitions array, also clearing the array when leveing a view (or searching for somtingelse in the case of the search view) also keeps the ratings array smal which makes looping thrue it to find a matching rating very fast.

However this feching of the episodes/podcast everytime one goes back so I might have to reconsider clering that array (and fixing my service worker);

I also created a new case for newEpisode types for notifications to enable displaying notifications for when subscribed podcasts publish new episodes. I have made some progress for making the backend part of this work, but I'm not at all sure that it's a viable solution. Right now I have set up the server to try to fetch all podcasts that anyone subscribes to once a day (with setInterval) and then adding them and crating and a event and emiting notifications to the users that have subscribed if the id of the the latest episode of the fetched podcast does not exist in my database. I also fetch the episodes and run the same function when when new user subscribes and have realized that I will also have to do this when someone rates a episode becouse (the rated episode might be a new episode that was added after the check for new episode was made that day and it's a lot esier if I just emit the notification as soon as the new episode is added (just the id) to my database (which it has to be if the episode is given a rating).

